<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gatekeeper | Campus Pulse</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        body {
            background: var(--obsidian);
            color: var(--pearl);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0; padding: 20px;
        }

        .header { text-align: center; margin-bottom: 30px; }
        .header h3 {
            margin: 0; font-weight: 900; font-size: 1.8rem;
            text-transform: uppercase; letter-spacing: 4px;
            color: var(--crimson);
            text-shadow: 0 0 20px rgba(113, 0, 20, 0.4);
        }

        /* --- SCANNER VIEWFINDER --- */
        .scanner-wrapper {
            position: relative;
            width: 100%; max-width: 400px;
            aspect-ratio: 1/1;
            background: #000;
            border-radius: 30px;
            overflow: hidden;
            border: 2px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
        }
        
        /* Scanning Laser Animation */
        .scanner-wrapper::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: var(--crimson);
            box-shadow: 0 0 15px var(--crimson);
            animation: scan 2s linear infinite;
            z-index: 10;
        }

        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }

        #reader { width: 100%; height: 100%; }

        /* --- BUTTONS --- */
        .btn-scan {
            margin-top: 40px; padding: 18px 60px;
            background: var(--crimson); color: var(--pearl);
            border: none; border-radius: 100px;
            font-size: 0.8rem; font-weight: 900; text-transform: uppercase;
            letter-spacing: 2px; cursor: pointer;
            transition: var(--transition);
        }
        .btn-scan:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(113, 0, 20, 0.4); }

        /* --- POPUP --- */
        .result-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 85%; max-width: 350px;
            padding: 40px 30px;
            background: var(--dark-grey); backdrop-filter: blur(20px);
            border-radius: 40px; border: 1px solid var(--glass-border);
            text-align: center;
            opacity: 0; pointer-events: none; transition: var(--transition);
            z-index: 100;
        }
        .result-box.active { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }
        .status-icon { font-size: 4rem; display: block; margin-bottom: 15px; }
        
        .success { border-color: #00ff9d; }
        .error { border-color: var(--crimson); }

        .scan-count-badge {
            display: inline-block; padding: 8px 20px; background: var(--glass-bg);
            border-radius: 100px; margin-top: 20px; color: var(--sand); 
            font-size: 0.7rem; font-weight: 800; text-transform: uppercase;
        }

        #debug-log { margin-top: 25px; color: var(--sand); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="header">
        <h3>GATEKEEPER</h3>
        <p style="color:var(--sand); font-size:0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">Admin Intel System</p>
    </div>

    <div class="scanner-wrapper">
        <div id="reader"></div>
    </div>

    <button onclick="initCamera()" class="btn-scan" id="startBtn">INITIALIZE CAMERA</button>
    
    <div id="debug-log">READY FOR DEPLOYMENT</div>

    <div id="result" class="result-box">
        <span class="status-icon" id="icon"></span>
        <h2 id="msg-title" style="font-weight: 900; letter-spacing: -1px;"></h2>
        <p id="msg-detail" style="color:var(--sand); margin: 15px 0; font-size: 0.9rem; font-weight: 600;"></p>
        <div class="scan-count-badge">LOGGED SCANS: <span id="scan-count-val">0</span></div>
    </div>

    <script>
        let html5QrCode;
        let isScanning = false;
        const debugDiv = document.getElementById('debug-log');

        function logStatus(msg) {
            debugDiv.innerText = msg;
        }

        async function initCamera() {
            document.getElementById('startBtn').style.display = 'none';
            logStatus("SYNCING OPTICS...");

            try {
                html5QrCode = new Html5Qrcode("reader");
                
                await html5QrCode.start(
                    { facingMode: "environment" }, // Forces back camera on mobile
                    {
                        fps: 20,
                        qrbox: { width: 250, height: 250 }
                    },
                    onScanSuccess,
                    (errorMessage) => { /* ignore frame errors */ }
                );
                logStatus("SYSTEM ACTIVE");
            } catch (err) {
                logStatus("HARDWARE FAILURE: " + err);
                document.getElementById('startBtn').style.display = 'block';
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            if (isScanning) return;
            isScanning = true;
            
            try { await html5QrCode.pause(); } catch(e){}

            // Updated Endpoint to match standard backend routing
            try {
                const response = await fetch('/events/scan-ticket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticket_id: decodedText })
                });
                const data = await response.json();
                showResult(response.ok, data);
            } catch (err) {
                showResult(false, { message: "ENCRYPTION ERROR / NETWORK LOST" });
            }

            // Auto-Resume cycle
            setTimeout(async () => {
                document.getElementById('result').classList.remove('active');
                try { 
                    if(html5QrCode) await html5QrCode.resume(); 
                } catch(e){}
                isScanning = false;
            }, 3000);
        }

        function showResult(isSuccess, data) {
            const box = document.getElementById('result');
            box.className = 'result-box ' + (isSuccess ? 'success' : 'error');
            
            document.getElementById('icon').innerText = isSuccess ? "✔️" : "⚠️";
            document.getElementById('msg-title').innerText = isSuccess ? "VERIFIED" : "ACCESS DENIED";
            document.getElementById('msg-detail').innerText = data.message;
            document.getElementById('scan-count-val').innerText = data.scan_count || 0;
            
            box.classList.add('active');
        }
    </script>
</body>
</html>